% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/slurm_job.R
\name{run_singularity_job}
\alias{run_singularity_job}
\title{Submit a Singularity container job via SLURM}
\usage{
run_singularity_job(
  name,
  container,
  command,
  working_dir,
  completion_files,
  bind_paths = NULL,
  gpu = FALSE,
  slurm_options = list(),
  env_vars = NULL,
  force_resubmit = FALSE
)
}
\arguments{
\item{name}{Character. Job name used for script filename and SLURM job name.}

\item{container}{Character. Path to the Singularity .sif file.}

\item{command}{Character. Command to run inside the container.}

\item{working_dir}{Character. Directory for script creation and job execution.}

\item{completion_files}{Character vector. Relative paths from working_dir
that indicate successful completion. First found file is returned.}

\item{bind_paths}{Character vector. Additional paths to bind into container.
Merged with cluster defaults (Apollo: /labs,/opt,/ref_genome,/run;
Gemini: /packages,/run,/ref_genomes,/scratch).}

\item{gpu}{Logical. If TRUE, adds --nv flag, sets gres=gpu:1,
and defaults partition to "gpu-a100".}

\item{slurm_options}{Named list. SLURM parameters:
\itemize{
\item time: Wall time (e.g., "24:00:00")
\item mem: Total memory (e.g., "64G")
\item cpus_per_task: Number of CPUs (integer)
\item partition: SLURM partition (default from cluster)
\item gres: Generic resources (e.g., "gpu:1")
\item Additional options passed as --name=value
}}

\item{env_vars}{Named list. Environment variables to export.}

\item{force_resubmit}{Logical. If TRUE, resubmit even if script exists.}
}
\value{
Path to completion file (if exists) or script path.
}
\description{
Convenience wrapper around \code{\link[=run_slurm_job]{run_slurm_job()}} for running commands inside
Singularity containers. Automatically handles bind paths and GPU settings.
}
\examples{
\dontrun{
# Cell Ranger count
tar_target(
  cellranger_result,
  run_singularity_job(
    name = paste0("cellranger_", sample_id),
    container = "/packages/singularity/shared_cache/cellranger.sif",
    command = paste(
      "cellranger count",
      "--id=", sample_id,
      "--fastqs=", fastq_dir,
      "--transcriptome=", ref_dir,
      "--localcores=$SLURM_CPUS_PER_TASK",
      "--localmem=58"
    ),
    working_dir = file.path(output_dir, sample_id),
    completion_files = "outs/filtered_feature_bc_matrix.h5",
    slurm_options = list(time = "24:00:00", cpus_per_task = 8L, mem = "64G")
  ),
  pattern = map(sample_id),
  cue = tar_cue(mode = "always"),
  deployment = "main"
)

# GPU job (CellBender)
tar_target(
  cellbender_result,
  run_singularity_job(
    name = paste0("cellbender_", sample_id),
    container = "/packages/singularity/shared_cache/cellbender.sif",
    command = "cellbender remove-background --cuda ...",
    working_dir = output_dir,
    completion_files = "output.h5",
    gpu = TRUE,
    slurm_options = list(time = "4:00:00", cpus_per_task = 4L, mem = "60G")
  ),
  cue = tar_cue(mode = "always"),
  deployment = "main"
)
}
}
